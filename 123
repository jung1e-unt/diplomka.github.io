window.exportExcel = function (table) {
    try {
        showExportModal();

        // üîé –µ—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–ª–∏ –Ω–µ —ç–ª–µ–º–µ–Ω—Ç ‚Äî –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–µ—Ä–≤—É—é —Ç–∞–±–ª–∏—Ü—É
        if (!(table instanceof HTMLTableElement)) {
            table = document.querySelector('table');
        }

        if (!table) {
            throw new Error('HTML —Ç–∞–±–ª–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        }

        /* === 1. –¢–∞–±–ª–∏—Ü–∞ ‚Üí Excel === */
        const ws = XLSX.utils.table_to_sheet(table, {
            raw: false,
            cellDates: true
        });

        /* === 2. –ê–≤—Ç–æ—à–∏—Ä–∏–Ω–∞ –∫–æ–ª–æ–Ω–æ–∫ === */
        const range = XLSX.utils.decode_range(ws['!ref']);
        ws['!cols'] = [];

        for (let C = range.s.c; C <= range.e.c; C++) {
            let maxLen = 10;
            for (let R = range.s.r; R <= range.e.r; R++) {
                const cell = ws[XLSX.utils.encode_cell({ r: R, c: C })];
                if (cell?.v) {
                    maxLen = Math.max(maxLen, cell.v.toString().length);
                }
            }
            ws['!cols'].push({ wch: maxLen + 2 });
        }

        /* === 3. –§–æ—Ä–º–∞—Ç –¥–∞—Ç/–≤—Ä–µ–º–µ–Ω–∏ === */
        Object.keys(ws).forEach(k => {
            const cell = ws[k];
            if (!cell || !cell.v) return;

            if (cell.v instanceof Date) {
                cell.t = 'd';
                cell.z = 'dd.mm.yyyy hh:mm';
            }

            // ISO —Å—Ç—Ä–æ–∫–∞
            if (typeof cell.v === 'string' && /^\d{4}-\d{2}-\d{2}/.test(cell.v)) {
                const d = new Date(cell.v);
                if (!isNaN(d)) {
                    cell.v = d;
                    cell.t = 'd';
                    cell.z = 'dd.mm.yyyy hh:mm';
                }
            }
        });

        /* === 4. Workbook === */
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, '–î–∞–Ω–Ω—ã–µ');

        /* === 5. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ === */
        const name = `export_${formatNowForFile()}.xlsx`;
        XLSX.writeFile(wb, name);

    } catch (e) {
        console.error(e);
        showErrorModal('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + e.message);
    } finally {
        hideExportModal();
    }
};
