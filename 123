    public IActionResult OnGetExport(string table, string? startDate, string? endDate, string? nPart, string? nPlaw)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(table))
                return BadRequest("Table is required.");

            var tableUpper = table.Trim().ToUpperInvariant();
            if (!AllowedTables.Contains(tableUpper))
                return BadRequest("Table is not allowed.");

            var dateColumn = ResolveDateColumn(tableUpper);
            var start = ParseDate(startDate);
            var end = ParseDate(endDate);

            var connString = _config.GetConnectionString("OracleConnection");
            using var conn = new OracleConnection(connString);
            conn.Open();

            var columns = GetColumns(conn, tableUpper, DefaultExcludeColumns);
            if (!columns.Any(c => string.Equals(c, dateColumn, StringComparison.OrdinalIgnoreCase)))
                return BadRequest($"Колонка даты '{dateColumn}' отсутствует в {tableUpper}.");

            var sql = BuildSql(tableUpper, columns, dateColumn, start, end, nPart, nPlaw);

            using var cmd = new OracleCommand(sql, conn)
            {
                BindByName = true
            };

            BindDateParams(cmd, start, end);

            if (!string.IsNullOrWhiteSpace(nPart) &&
                columns.Any(c => string.Equals(c, "N_PART", StringComparison.OrdinalIgnoreCase)))
            {
                cmd.Parameters.Add(new OracleParameter("pNPart", OracleDbType.Varchar2) { Value = nPart });
            }

            if (!string.IsNullOrWhiteSpace(nPlaw) &&
                columns.Any(c => string.Equals(c, "N_PLAW", StringComparison.OrdinalIgnoreCase)))
            {
                cmd.Parameters.Add(new OracleParameter("pNPlaw", OracleDbType.Varchar2) { Value = nPlaw });
            }

            using var reader = cmd.ExecuteReader();
            var dt = ToDataTable(reader);

            using var wb = new XLWorkbook();
            var ws = wb.Worksheets.Add(dt, tableUpper);

            var tbl = ws.Tables.FirstOrDefault();
            if (tbl != null) tbl.ShowAutoFilter = true;

            ws.SheetView.FreezeRows(1);
            ApplyDateColumnFormats(ws, dt);
            ApplyDateColumnFormats2(ws, dt);
            ws.Columns().AdjustToContents();

            byte[] bytes;
            using (var ms = new MemoryStream())
            {
                wb.SaveAs(ms);
                bytes = ms.ToArray();
            }

            var fileName = $"{tableUpper}_{DateTime.Now:ddMMyy}.xlsx";
            return File(bytes, ContentTypeXlsx, fileName);
        }
        catch (OracleException ex) when (ex.Number == 8180 || ex.Number == 8181)
        {
            using var wbEmpty = new XLWorkbook();
            var wsEmpty = wbEmpty.Worksheets.Add(table.ToUpperInvariant());
            wsEmpty.Cell(1, 1).Value = "Нет данных";
            wsEmpty.Columns().AdjustToContents();

            byte[] emptyBytes;
            using (var msEmpty = new MemoryStream())
            {
                wbEmpty.SaveAs(msEmpty);
                emptyBytes = msEmpty.ToArray();
            }

            return File(emptyBytes, ContentTypeXlsx, $"{table.ToUpperInvariant()}_{DateTime.Now:ddMMyy}.xlsx");
        }
        catch (Exception ex)
        {
            return StatusCode(500, $"Export failed: {ex.GetType().Name}: {ex.Message}");
        }
    }

