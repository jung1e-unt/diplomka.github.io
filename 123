<script>
window.exportExcel = async function(table) {
  showExportModal();
  try {
    const p = collectFilterParams();
    if (table) p.set('table', table);

    const sep = exportBaseUrl.includes('?') ? '&' : '?';
    const url = `${exportBaseUrl}${sep}${p.toString()}`;

    const resp = await fetch(url);
    if (!resp.ok) throw new Error(`HTTP ${resp.status}`);

    const cd = resp.headers.get('Content-Disposition') || '';
    const m  = cd.match(/filename\*=UTF-8''([^;]+)|filename="?([^\";]+)"?/i);
    const raw = m ? (m[1] || m[2]) : null;

    const fileName = raw
      ? decodeURIComponent(raw)
      : `${(table || 'export')}_${formatNowForFile()}.xlsx`;

    const buffer = await resp.arrayBuffer();

    const wb = XLSX.read(buffer, {
      type: 'array',
      cellDates: false
    });

    wb.SheetNames.forEach(sheetName => {
      const ws = wb.Sheets[sheetName];
      if (!ws['!ref']) return;

      Object.keys(ws).forEach(addr => {
        if (addr[0] === '!') return;

        const c = ws[addr];
        if (!c || c.t !== 'n' || typeof c.v !== 'number') return;

        const v = c.v;
        const abs = Math.abs(v);
        const frac = abs % 1;

        // ================= ðŸ•’ Ð§Ð˜Ð¡Ð¢ÐžÐ• Ð’Ð Ð•ÐœÐ¯ =================
        if (abs < 1 && frac > 0) {
          const minutes = Math.round(frac * 1440);
          const h = Math.floor(minutes / 60) % 24;
          const m = minutes % 60;

          c.t = 's';
          c.v = `${pad(h)}:${pad(m)}`;
          delete c.z;
          return;
        }

        // ================= ðŸ“… Ð”ÐÐ¢Ð / Ð”ÐÐ¢Ð+Ð’Ð Ð•ÐœÐ¯ =================
        if (abs >= 1 && abs < 60000) { // Ð·Ð°Ñ‰Ð¸Ñ‚Ð° Ð¾Ñ‚ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ñ… Ñ‡Ð¸ÑÐµÐ»
          const d = XLSX.SSF.parse_date_code(v);
          if (!d || !d.y) return;

          const jsDate = new Date(
            d.y, d.m - 1, d.d,
            d.H || 0, d.M || 0, d.S || 0
          );

          // Ð”Ðž 1900 â†’ Ñ‚ÐµÐºÑÑ‚
          if (jsDate < new Date(1900, 0, 1)) {
            c.t = 's';
            c.v = frac > 0
              ? formatDateTime(jsDate)
              : formatDate(jsDate);
            delete c.z;
            return;
          }

          // >= 1900 â†’ Ð¾ÑÑ‚Ð°Ð²Ð»ÑÐµÐ¼ Ñ‡Ð¸ÑÐ»Ð¾Ð¼ (Excel ÑÐ°Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€ÑƒÐµÑ‚)
          if (frac === 0) {
            c.z = 'dd.mm.yyyy';
          } else {
            c.z = 'dd.mm.yyyy hh:mm';
          }
        }
      });

      autoFitColumns(ws);

      // Ñ„Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²ÐºÐ°Ð¼
      ws['!autofilter'] = { ref: ws['!ref'] };
    });

    const out = XLSX.write(wb, {
      bookType: 'xlsx',
      type: 'array'
    });

    const blob = new Blob([out], {
      type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
    });

    download(blob, fileName);

  } catch (e) {
    console.error(e);
    showErrorModal('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÑÐ¿Ð¾Ñ€Ñ‚Ð°: ' + e.message);
  } finally {
    hideExportModal();
  }
};

// ================= HELPERS =================

const pad = n => String(n).padStart(2,'0');

function formatDate(d) {
  return `${pad(d.getDate())}.${pad(d.getMonth()+1)}.${d.getFullYear()}`;
}

function formatDateTime(d) {
  return `${formatDate(d)} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}

function autoFitColumns(ws) {
  const range = XLSX.utils.decode_range(ws['!ref']);
  const cols = [];

  for (let C = range.s.c; C <= range.e.c; C++) {
    let maxLen = 8;
    for (let R = range.s.r; R <= range.e.r; R++) {
      const cell = ws[XLSX.utils.encode_cell({ r: R, c: C })];
      if (!cell || cell.v == null) continue;
      maxLen = Math.max(maxLen, String(cell.v).length);
    }
    cols[C] = { wch: Math.min(maxLen + 2, 40) };
  }
  ws['!cols'] = cols;
}

function download(blob, name) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

function formatNowForFile() {
  const d = new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}_${pad(d.getHours())}-${pad(d.getMinutes())}`;
}
</script>
