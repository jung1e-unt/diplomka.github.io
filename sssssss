using ClosedXML.Excel;
using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Mvc.RazorPages;
using Microsoft.Extensions.Configuration;
using Oracle.ManagedDataAccess.Client;
using System;
using System.Collections.Generic;
using System.Data;

public class IndexModel : PageModel
{
    private readonly IConfiguration _config;

    public IndexModel(IConfiguration config)
    {
        _config = config;
    }

    public class ColumnInfo
    {
        public string Name { get; set; }
        public string Type { get; set; }
    }

    public List<ColumnInfo> Columns { get; set; } = new();
    public DataTable TableData { get; set; } = new();

    public void OnGet()
    {
        LoadColumns();
        LoadData(null);
    }

    public IActionResult OnPostFilter(string column, string columnType, string numberValue,
                                      string textValue, string dateFrom, string dateTo)
    {
        LoadColumns();

        string where = BuildWhere(column, columnType, numberValue, textValue, dateFrom, dateTo);

        LoadData(where);

        return Page();
    }

    private void LoadColumns()
    {
        Columns.Clear();

        using var conn = new OracleConnection(_config.GetConnectionString("DefaultConnection"));
        conn.Open();

        using var cmd = new OracleCommand(@"
            SELECT COLUMN_NAME, DATA_TYPE 
            FROM ALL_TAB_COLUMNS 
            WHERE TABLE_NAME = 'MY_TABLE'
            ORDER BY COLUMN_ID
        ", conn);

        using var rd = cmd.ExecuteReader();
        while (rd.Read())
        {
            Columns.Add(new ColumnInfo
            {
                Name = rd.GetString(0),
                Type = rd.GetString(1)
            });
        }
    }

    private void LoadData(string where)
    {
        using var conn = new OracleConnection(_config.GetConnectionString("DefaultConnection"));
        conn.Open();

        string sql = "SELECT * FROM MY_TABLE";

        if (!string.IsNullOrEmpty(where))
            sql += " WHERE " + where;

        using var da = new OracleDataAdapter(sql, conn);
        TableData.Clear();
        da.Fill(TableData);
    }

    private string BuildWhere(string column, string type, string numberValue,
                              string textValue, string dateFrom, string dateTo)
    {
        if (type.Contains("NUMBER"))
        {
            return $"{column} = {numberValue}";
        }

        if (type.Contains("CHAR") || type.Contains("VARCHAR"))
        {
            return $"{column} LIKE '%{textValue}%'";
        }

        if (type.Contains("DATE"))
        {
            return $"{column} BETWEEN TO_DATE('{dateFrom}', 'YYYY-MM-DD') 
                                 AND TO_DATE('{dateTo}', 'YYYY-MM-DD')";
        }

        return null;
    }
}



@page
@model IndexModel
@{
    Layout = null;
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Фильтрация таблицы</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" />
</head>

<body class="p-4">

<h2>Фильтрация</h2>

<form method="post" asp-page-handler="Filter" class="border p-3">
    <div class="row mb-3">
        <div class="col-4">
            <label>Колонка</label>
            <select name="column" id="columnSelect" class="form-select" required>
                <option disabled selected>Выберите колонку</option>
                @foreach (var col in Model.Columns)
                {
                    <option value="@col.Name" data-type="@col.Type">@col.Name</option>
                }
            </select>

            <input type="hidden" id="columnType" name="columnType" />
        </div>

        <div class="col-8">

            <!-- NUMBER -->
            <div id="field-number" style="display:none">
                <label>Введите число:</label>
                <input class="form-control" type="number" name="numberValue" />
            </div>

            <!-- TEXT -->
            <div id="field-text" style="display:none">
                <label>Введите текст:</label>
                <input class="form-control" type="text" name="textValue" />
            </div>

            <!-- DATE -->
            <div id="field-date" style="display:none">
                <label>Дата от:</label>
                <input class="form-control" type="date" name="dateFrom" />
                <label class="mt-2">Дата до:</label>
                <input class="form-control" type="date" name="dateTo" />
            </div>

        </div>
    </div>

    <button class="btn btn-primary">Фильтровать</button>
</form>

<hr />

<h2>Результаты</h2>

<table class="table table-bordered table-striped">
    <thead>
        <tr>
            @foreach (DataColumn col in Model.TableData.Columns)
            {
                <th>@col.ColumnName</th>
            }
        </tr>
    </thead>

    <tbody>
        @foreach (DataRow row in Model.TableData.Rows)
        {
            <tr>
                @foreach (var cell in row.ItemArray)
                {
                    <td>@cell</td>
                }
            </tr>
        }
    </tbody>
</table>

<script>
document.getElementById("columnSelect").addEventListener("change", function () {
    const type = this.options[this.selectedIndex].dataset.type.toUpperCase();

    document.getElementById("columnType").value = type;

    document.getElementById("field-number").style.display = "none";
    document.getElementById("field-text").style.display = "none";
    document.getElementById("field-date").style.display = "none";

    if (type.includes("NUMBER")) {
        document.getElementById("field-number").style.display = "block";
    } 
    else if (type.includes("CHAR") || type.includes("VARCHAR")) {
        document.getElementById("field-text").style.display = "block";
    } 
    else if (type.includes("DATE")) {
        document.getElementById("field-date").style.display = "block";
    }
});
</script>

</body>
</html>
