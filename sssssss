// ==========================
//  С О Х Р А Н Е Н И Е  С О С Т О Я Н И Я
// ==========================

// Ключ для хранения
const LS_KEY = "uiState";

function saveState() {
    const selected = Array.from(
        document.querySelectorAll('#tableGroups input[type="checkbox"]:checked')
    ).map(cb => cb.dataset.table);

    const state = {
        selectedTables: selected,
        currentTable: currentTable,
        filters: {
            startDate: $id('startDate')?.value || "",
            endDate:   $id('endDate')?.value || "",
            nPart:     $id('nPart')?.value || "",
            nPlaw:     $id('nPlaw')?.value || ""
        }
    };

    localStorage.setItem(LS_KEY, JSON.stringify(state));
}

// Каждое действие пользователя сохраняет состояние
document.addEventListener("change", saveState);
document.addEventListener("click", saveState);

// ==========================
//  В О С С Т А Н О В Л Е Н И Е
// ==========================

function restoreState() {
    const raw = localStorage.getItem(LS_KEY);
    if (!raw) return;

    const state = JSON.parse(raw);

    // восстановить чекбоксы
    if (state.selectedTables) {
        for (const cb of document.querySelectorAll('#tableGroups input[type="checkbox"]')) {
            cb.checked = state.selectedTables.includes(cb.dataset.table);
        }
    }

    // восстановить выбранные кнопки слева
    renderSelectedButtons(state.selectedTables || []);

    // восстановить фильтры
    if (state.filters) {
        if ($id('startDate')) $id('startDate').value = state.filters.startDate;
        if ($id('endDate'))   $id('endDate').value   = state.filters.endDate;
        if ($id('nPart'))     $id('nPart').value     = state.filters.nPart;
        if ($id('nPlaw'))     $id('nPlaw').value     = state.filters.nPlaw;
    }

    // восстановить текущую таблицу
    if (state.currentTable) {
        currentTable = state.currentTable;
        enableFilters(true);

        // загрузить данные таблицы сразу
        loadTable(currentTable, true);
    }
}

// запускаем восстановление после полной загрузки
document.addEventListener("DOMContentLoaded", () => {
    setTimeout(restoreState, 50); // даём таблицам отрендериться
});
